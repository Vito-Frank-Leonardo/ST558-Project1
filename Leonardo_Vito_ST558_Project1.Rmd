---
title: "Project1"
author: "Vito Frank Leonardo"
date: "6/14/2021"
output: 
  html_document:
    toc: yes
    toc_float: no
    toc_depth: 3
---
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# About  
  
This project is a vignette for reading and summarizing data from the National Hockey Leagueâ€™s (NHL) API. The vignette will cover 9 functions used to pull data from the following endpoints from the API: *General Franchise Info*, *Team Totals*, *Team Season Records*, *Team Goalie Records*, *Team Skater Stats*, and more. Each function will have the ability to input the team ID numbers that the user wants to access in vector format. If the user does not know the team ID numbers, they will have the ability to input the names of the teams in vector format as well. After the functions are well defined, I will demonstrate how the functions can be used and perform a basic Exploratory Data Analysis (EDA) using the functions.  
  
# Packages Needed  
  
The packages need are follows: 
  - `tidyverse` for manipulating data  
  - `httr` for accessing the API  
  - `gtools` to use the `smartbind()` function when combining data  
  
Once you install these packages using `install.packages('package')`, we will library them like below.   
```{r, message=FALSE}
library(tidyverse)
library(httr)
library(gtools)
```


# Accessing the API to Read the Data  
  
## Store the Base URLs  
  
Since we will be using the Base URL's from the API frequently, we will store them as variables below.   
```{r BaseURL}
Base_URL <- "https://records.nhl.com/site/api"
Base_URL_Stats <- "https://statsapi.web.nhl.com/api/v1/teams/"
```
  
## Assisting Functions  
  
Since we are going to be writing many functions accessing similar endpoints for the APIs, we want to define some functions below that contain code that we will use in more than 1 function. 

### Access Data Function 1 
  
Since the `Franchise Info` and `Team Totals` endpoints will access data using similar sets of functions, we will define a wrapper function called `AccessData1` that will return the data from the API in list format. The function will have the following inputs: *the Base URL* and *the endpoint or modifier*. The steps are as follows:  
  1. Combine the Base URL with the endpoint using the `paste0()` function and store it as `Full_URL` 
  2. Use the `GET()` function from the `httr` library to retrieve the information from the URL and save it as `req` for request  
  3. Use the `content()` function from the `httr` library to convert the information into a list of data that can be accessed with R and return it to the user. 
  
```{r}
AccessData1 <- function(BaseURL, Endpoint){
  Full_URL <- paste0(BaseURL,Endpoint)
  req <- GET(Full_URL) # from httr library
  return(content(req)) # from httr library
}
```

### Access Function 2  
  
For the `Season`, `Goalie`, and `Skater` endpoints, the URL's are structured similarly and they return similar outputs so, we can write a function that can be used in both endpoint functions. The function `AccessData2` functions exactly the same as `AccessData1` except the endpoint is structured differently. The functionality is exactly the same but since the endpoint requires the franchise ID be specified, it is an input of the function. See below:  

```{r}
AccessData2 <- function(BaseURL, Type,ID){

  Endpoint <- paste0("/franchise-",Type,"-records?cayenneExp=franchiseId=",ID)
  req <- GET(paste0(BaseURL,Endpoint)) # from httr library
  return( content(req) ) # from httr library

}  

``` 

### Return Function 1  
  
This return function will take the data.frame (`df`) that we created from the raw data list from the API and return it based on the specified ID and Name vectors inputted by the users. We will place this function inside our functions that we use to access the API endpoint.  
If both `ID` and `Name` are `NULL`, then the function will return the entire data set. If not, the function will return on the teams specified.   
  
```{r}
ReturnFun1 <- function(df, ID=NULL, Name = NULL){
    if(is.null(ID) & is.null(Name)){
    return(df)
  } else{
      NamesDf <- df %>% 
       select(id, teamCommonName) %>%
       filter(teamCommonName %in% Name)
      ID <- unique(union(ID,unlist(NamesDf$id )))
  
    return(df %>% filter(id %in% ID))
  }
}
```
  

## Access Franchise Info 
 
Below is the function used to access the franchise endpoint which Returns id, firstSeasonId and lastSeasonId and name of every team in the history of the NHL. The steps to create the function are as follows:  
  1. Use the `AccessData` function (that we previously defined) to access the data list and store it as `data`
  2. Using a for loop, we will loop through each layer of the list to create a data frame with all of the information  
  3. Lastly, we will call the *return function* (`ReturnFun1()`) previously defined to return the data specified by the user. 

```{r Franchise}
FranchiseInfo <- function(ID=NULL, Name=NULL){
  
  data <- AccessData1(BaseURL = Base_URL, Endpoint = "/franchise")
  
  df <- data.frame(matrix(rep(0,8), nrow=1))
  colnames(df) <- names(data$data[[2]])
  for( i in 1:length(data$data)){
    datalist <- data$data[[i]]
    temp <- data.frame(matrix(datalist, nrow=1))
    df[i,] <- temp
  }
  
  ReturnFun1(df, ID, Name)

}
```  
  
## Accessing Team Totals   
  
Below is a function written to access an endpoint that returns Total stats for every franchise. We will access the data as follows: 
  1. Use the `AccessData` function (that we previously defined) to access the data list and store it as `data`
  2. Using a for loop, we will loop through each layer of the list to create a data frame with all of the information  
  3. Using the previously defined API endpoint function, `FranchiseInfo()`, we will pull the dataset with all the team IDs and names then left join it will our data frame
  4. Lastly, we will call `ReturnFun1()` to return the data set with the ID and/or Team Names specified by the user. 

```{r teamTotals}

TeamTotals <- function(ID=NULL, Name=NULL){

  data <- AccessData1(BaseURL = Base_URL, Endpoint =  "/franchise-team-totals")

  df <- data.frame(matrix(rep(0,length(data$data[[1]])), nrow=1))
  colnames(df) <- names(data$data[[2]])
  for( i in 1:length(data$data)){
    datalist <- data$data[[i]]
    temp <- data.frame(matrix(datalist, nrow=1))
    df[i,] <- temp
  }
  
  NamesDf <- FranchiseInfo(ID,Name) %>% 
    select(id, teamCommonName) %>%
    rename(franchiseId = id) 
  
  df <- df %>% left_join(NamesDf,"franchiseId")
  
  ReturnFun1(df, ID, Name)
}

```
 
## Accessing Season Records 

Below is the function used to access the endpoint that returns season records for a specific franchise. Since the endpoint requires an ID, we have to pull the data for each franchise individually and combine them. Since this is an exhaustive process, we will reduce the computation time by filtering which teams we want to pull the data from before we gather all the data instead of after like in the previous functions. The steps are as follows:  
  1. Use the `FranchiseInfo()` function to gather all of the general information for each team specified in the `ID` and `Name` input. We do this just in case the user specified only the `Name=` input or put a combination of `ID=` and `Name=`. 
  2. Use the previous step to create a new vector called `ID` of all the id's specified by the user. 
  3. Use the `AccessData2()` function to gather the data for the first id specified and create a data frame with 1 row of the data. 
  4. If there was more than 1 team specified, we will repeat step 3 in a loop until all data for each id is gathered and combined into one data.frame. 
  5. Return the data.frame for the user. 
    
```{r Season}

SeasonRecords <- function(ID =NULL, Name = NULL){

  NamesDf <- FranchiseInfo(ID,Name) 
  ID <- unlist(NamesDf$id )
  
  Type = "season"
  data <- AccessData2(Base_URL, Type, ID[1])
  df <- data.frame(matrix(data$data[[1]],nrow = 1))
  colnames(df) <- names(data$data[[1]])
  
  if(length(ID)!=1){
    for(i in 2:length(ID)){
    data <- AccessData2(Base_URL, Type, ID[1])
    temp <- data.frame(matrix(data$data[[1]],nrow = 1))
    colnames(temp) <- names(df)
    df <- rbind(df,temp)
    }
  }

  return(df)
}
```

## Accessing Goalie Records 

Below is the function used to access the endpoint that returns Goalie records for the specified franchise. The function follows the same structure as `SeasonRecords` except there are many layers for each ID. Thus, it requires an extra for loop to loop through all the layers of data. The Steps are as follows: 
  1. Use the `FranchiseInfo()` function to gather all of the general information for each team specified in the `ID` and `Name` input. We do this just in case the user specified only the `Name=` input or put a combination of `ID=` and `Name=`. 
  2. Use the previous step to create a new vector called `ID` of all the id's specified by the user. 
  3. Use the `AccessData2()` function to gather the data for the first id specified and create a data frame with the 1st list of the data. 
  4. Use a for loop to gather the information from the rest of the lists in the data set and add them to the data.frame. 
  4. If there was more than 1 team specified, we will repeat step 3 in a loop until all data for each id is gathered and combined into one data.frame. 
  5. Return the data.frame for the user. 

```{r}

GoalieRecords <- function(ID =NULL, Name = NULL){
  
  NamesDf <- FranchiseInfo(ID,Name) 
  ID <- unlist(NamesDf$id )
  ID <- ID[!ID == 39]
  
  Type <- "goalie"
  data <- AccessData2(Base_URL,Type,ID[1])
  df <- data.frame(matrix(data$data[[1]],nrow = 1))
  colnames(df) <- names(data$data[[1]])
  for(j in 2:length(data$data)){
    temp <- data.frame(matrix(data$data[[j]],nrow = 1))
    colnames(temp) <- colnames(df)
    df <- rbind(df,temp)
  }
  
  
  
  if(length(ID)!= 1){
    for(i in 2:length(ID)){
    data <- AccessData2(Base_URL,Type,ID[i])
      for(j in 1:length(data$data)){
      temp <- data.frame(matrix(data$data[[j]],nrow = 1))
      colnames(temp) <- colnames(df)
      df <- rbind(df,temp)
      }
    }
  }

  return(df)
}  
```

# Accessing Skater Records

Below is the function used to access the endpoint that returns Goalie records for the specified franchise. The function follows exactly the same staps as the previous function except the URL uses a different `Type`. See the function below. The Steps are as follows: 
  1. Use the `FranchiseInfo()` function to gather all of the general information for each team specified in the `ID` and `Name` input. We do this just in case the user specified only the `Name=` input or put a combination of `ID=` and `Name=`. 
  2. Use the previous step to create a new vector called `ID` of all the id's specified by the user. 
  3. Use the `AccessData2()` function to gather the data for the first id specified and create a data frame with the 1st list of the data. 
  4. Use a for loop to gather the information from the rest of the lists in the data set and add them to the data.frame. 
  4. If there was more than 1 team specified, we will repeat step 3 in a loop until all data for each id is gathered and combined into one data.frame. 
  5. Return the data.frame for the user. 

```{r}

SkaterRecords <- function(ID =NULL, Name = NULL){

  NamesDf <- FranchiseInfo(ID,Name) 
  ID <- unlist(NamesDf$id )
  ID <- ID[!ID == 39]
  Type = "skater"

  data <- AccessData2(Base_URL,Type,ID[1])
  df <- data.frame(matrix(data$data[[1]],nrow = 1))
  colnames(df) <- names(data$data[[1]])
  for(j in 2:length(data$data)){
    temp <- data.frame(matrix(data$data[[j]],nrow = 1))
    colnames(temp) <- colnames(df)
    df <- rbind(df,temp)
  }
  
  
  
  if(length(ID)!= 1){
    for(i in 2:length(ID)){
    data <- AccessData2(Base_URL,Type,ID[i])
      for(j in 1:length(data$data)){
      temp <- data.frame(matrix(data$data[[j]],nrow = 1))
      colnames(temp) <- colnames(df)
      df <- rbind(df,temp)
      }
    }
  }

  return(df)

}
```


## Accessing Admin History

Below is the function used to access the admin history and retired numbers. The steps are as follows: 
  1. Use the `FranchiseInfo()` function to gather all of the general information for each team specified in the `ID` and `Name` input. We do this just in case the user specified only the `Name=` input or put a combination of `ID=` and `Name=`. 
  2. Use the previous step to create a new vector called `ID` of all the id's specified by the user. 
  3. Use the `AccessData1()` function to gather the data for the first id specified and create a data frame with the 1st list of the data. 
  4. Use a for loop to gather the information from the rest of the lists in the data set and add them to the data.frame. 
  4. If there was more than 1 team specified, we will repeat step 3 in a loop until all data for each id is gathered and combined into one data.frame. 
  5. Return the data.frame for the user.  
    
```{r}
AdminRecords <- function(ID =NULL, Name = NULL){
  
  NamesDf <- FranchiseInfo(ID,Name) 
  ID <- unlist(NamesDf$id )
  ID <- ID[!ID == 39]
  df<-NULL
  
  Endpoint <- paste0("/franchise-detail?cayenneExp=mostRecentTeamId=",ID[1])
  data <- AccessData1(Base_URL, Endpoint)
  if(!is.null(unlist(data$data))){
    df <- data.frame(matrix(data$data[[1]],nrow = 1))
    colnames(df) <- names(data$data[[1]])
  }
  
  if(length(ID)!=1){
    for(i in 2:length(ID)){
    Endpoint <- paste0("/franchise-detail?cayenneExp=mostRecentTeamId=",ID[i])
    data <- AccessData1(Base_URL, Endpoint)
      if(!is.null(unlist(data$data))){
        temp <- data.frame(matrix(data$data[[1]],nrow = 1))
        colnames(temp) <- names(df)
        df <- rbind(df,temp) 
      }
    }
  }
  if(is.null(df)){
    stop("There is no data for the ID specified")
  }
  return(df)
}

```
  
## Accessing Admin History 
  
The below function uses the NHL stats API to access various team stats of a single team or return data from all teams. The steps are as follows: 
  1. Use the `FranchiseInfo()` function to gather all of the general information for each team specified in the `ID` and `Name` input. We do this just in case the user specified only the `Name=` input or put a combination of `ID=` and `Name=`. 
  2. Use the previous step to create a new vector called `ID` of all the id's specified by the user. 
  3. Pull the data from the endpoint for the the first team ID and convert into a data.frame. 
  4. Use a for loop to gather the information from the teams and add them to the data.frame created in step 3. 
  4. Filter the data.frame by the teams input by the user and found in step 2. 
  5. Return the data.frame for the user.  
  
```{r}

StatsExpandMod <- function(ID=NULL,Name=NULL){
  
  NamesDf <- FranchiseInfo(ID,Name) 
  ID <- unlist(NamesDf$id )
  ID <- ID[!ID == 39]
  df<-NULL
  
  Modifier <- "?expand=team.stats"
  req <- GET(paste0(Base_URL_Stats,1,Modifier)) # from httr library
  data <- content(req) # from httr library
  df <- data.frame(data$teams[[1]])
  for(i in 2:38){
    req <- GET(paste0(Base_URL_Stats,i,Modifier)) # from httr library
    data <- content(req) # from httr library
    temp <- data.frame(data$teams[[1]])
    df <- smartbind(df,temp)
    }    
  if(!is.null(ID)){
    return(df %>% filter(franchise.franchiseId %in% ID))
  } else return(df)
}

```

## Wrapper Function 
  
Below is the code for a `Wrapper` function that will allow us to gather data from any of the endpoints we created functions for. The `Wrapper` function takes in the following inputs: `fun`, `ID`, and `Name`. The `fun` input tells the wrapper function which endpoint to pull the data from. The `ID` and `Name` are the same inputs from all of the previous functions. We wrap all the previous functions in a switch function; this calls the right endpoint given what was entered into `fun`.   
  
```{r Wrapper}
Wrapper <- function(fun,ID=NULL,Name=NULL){
  switch(fun,
             Info = FranchiseInfo(ID,Name),
             Totals = TeamTotals(ID,Name),
             Goalie = GoalieRecords(ID,Name), 
             Season = SeasonRecords(ID,Name), 
             Skater = SkaterRecords(ID,Name), 
             Admin= AdminRecords(ID,Name), 
             TeamStat = StatsExpandMod(ID,Name),
             stop("fun must be one of the following: Info, Totals, Goalie, Season, Skater, Admin or TeamStat. fun must also be in quotation marks"))
  
}
```

# Exploratory Data Analysis 
```{r}
NY.Info <-Wrapper("Info", Name = c("Islanders", "Rangers", "Sabres"))
NY.Teams <- c("Islanders", "Rangers", "Sabres")
NY.Season <- Wrapper("Season", Name = NY.Teams)
NY.Skater <- Wrapper("Skater",  Name = NY.Teams)
NY.TeamStat<- Wrapper("TeamStat",Name = NY.Teams)
NY.Totals <- Wrapper("Totals", Name = NY.Teams)
table(unlist(NY.Skater$franchiseName))
table(unlist(NY.Skater$franchiseName),unlist(NY.Skater$activePlayer))
table(unlist(NY.Skater$franchiseName),unlist(NY.Skater$seasons))

# Use NY.Totals to compare totals between teams in playoffs vs regular season
NY.Totals.edit <- NY.Totals %>%
  mutate(WinPerc = as.numeric(wins)/as.numeric(gamesPlayed))

ggplot(data = NY.Totals.edit, 
       mapping = aes(x=factor(unlist(teamName)), y = WinPerc, fill = factor(unlist(gameTypeId))))+
  geom_bar(stat = "identity", position = "dodge")

NY.Skater %>% 
  mutate(franchiseName = factor(unlist(franchiseName)),
         activePlayer = factor(unlist(activePlayer))) %>%
  group_by(franchiseName, activePlayer) %>%
  summarise(avgGames = mean(as.numeric(gamesPlayed)), 
            medGames = median(as.numeric(gamesPlayed)), 
            varGames = var(as.numeric(gamesPlayed)) )

NY.Skater %>% 
  mutate(franchiseName = factor(unlist(franchiseName)),
         activePlayer = factor(unlist(activePlayer))) %>%
  group_by(franchiseName, activePlayer) %>%
  summarise(avgGoals = mean(as.numeric(goals)), 
            medGoals = median(as.numeric(goals)), 
            varGoals = var(as.numeric(goals)) )

NY.Skater %>% 
  mutate(franchiseName = factor(unlist(franchiseName)),
         activePlayer = factor(unlist(activePlayer))) %>%
  group_by(franchiseName, activePlayer) %>%
  summarise(avgAssists = mean(as.numeric(assists)), 
            medAssists = median(as.numeric(assists)), 
            varAssists = var(as.numeric(assists)) )

NY.Skater %>% 
  filter(seasons > 3) %>%
  mutate(franchiseName = factor(unlist(franchiseName)),
         activePlayer = factor(unlist(activePlayer))) %>%
  group_by(franchiseName, activePlayer) %>%
  summarise(avgGoals = mean(as.numeric(goals)), 
            medGoals = median(as.numeric(goals)), 
            varGoals = var(as.numeric(goals)) )

NY.Skater %>% 
  filter(seasons > 3) %>%
  mutate(franchiseName = factor(unlist(franchiseName)),
         activePlayer = factor(unlist(activePlayer))) %>%
  group_by(franchiseName, activePlayer) %>%
  summarise(avgAssists = mean(as.numeric(assists)), 
            medAssists = median(as.numeric(assists)), 
            varAssists = var(as.numeric(assists)) )

NY.Skater.edit <- NY.Skater %>% 
  filter(seasons > 3) %>%
  mutate(NYteams = factor(unlist(franchiseName)),
         activePlayer = factor(unlist(activePlayer)), 
         assists = as.numeric(assists),
         goals = as.numeric(goals), 
         gamesPlayed = as.numeric(gamesPlayed),
         GoalsPerGame = goals/gamesPlayed,
         AssistsPerGame = assists/gamesPlayed) 

ggplot(data = NY.Skater.edit, mapping = aes(x=NYteams, y=goals))+
  geom_boxplot() +
  geom_jitter(aes(color = NYteams))+
  labs(x = "NY Teams")

ggplot(data = NY.Skater.edit, mapping = aes(x=NYteams, y=assists))+
  geom_boxplot() +
  geom_jitter(aes(color = NYteams))+
  labs(x = "NY Teams")
# Historically the teams seem to be the same

ggplot(data = NY.Skater.edit,
       mapping = aes(x=goals, fill = NYteams))+
  geom_histogram() +
  facet_grid(col = vars(NYteams))

ggplot(data = NY.Skater.edit, 
       mapping = aes(x=GoalsPerGame, 
                     y = AssistsPerGame, 
                     group = NYteams, 
                     color = NYteams)) +
  geom_point() +
  geom_smooth(method = lm, aes(color = NYteams)) 
  

BestScorers <- NY.Skater %>% 
  mutate(NYteams = factor(unlist(franchiseName)),
         activePlayer = factor(unlist(activePlayer))) %>%
  group_by(NYteams, activePlayer) %>%
  summarise(maxGoals = max(as.numeric(goals)) )


ggplot(BestScorers, aes(x=NYteams,fill = activePlayer)) +
  geom_bar(aes(y=maxGoals),position = "dodge", stat = "identity")
# Islanders have the best scorer in NY history and currently have the best active scorer

NY.TeamStat.edit <- NY.TeamStat %>% 
  select(name, teamStats.splits.stat.goalsPerGame, teamStats.splits.stat.shotsPerGame) %>%
  rename(GoalsPerGame = teamStats.splits.stat.goalsPerGame, 
         ShotsPerGame = teamStats.splits.stat.shotsPerGame) %>%
  mutate(ScorePerc = GoalsPerGame/ShotsPerGame) %>%
  gather(key = Variable, value = value, 2:3)
View(NY.TeamStat.edit)

# compare averages
ggplot(NY.TeamStat.edit, mapping = aes(x=factor(name), fill = Variable))+
    geom_bar(aes(y=value),position = "dodge", stat = "identity")
# Best average scoring percentage per game
ggplot(NY.TeamStat.edit, mapping = aes(x=factor(name)))+
  geom_bar(aes(y=ScorePerc/2, fill = factor(name)), stat = "identity")

```


